# TaosLife

个人网站，记录想法。支持 Markdown、语义搜索、AI 对话、SEO。简洁、轻快、优雅。

## 技术栈

- Nuxt 3
- TailwindCSS
- Supabase (Auth, Database, Storage, Vectors)
- Vercel (Deployment, Web Analytic, AI Gateway)

## 编辑器

推荐使用 VS Code，安装以下插件：

- Vue (Official)
- Tailwind CSS IntelliSense
- Prettier
- Iconify IntelliSense

## 开始

```bash
npm install       # 安装依赖
npm run dev       # 开发服务器
npm run check     # 检查依赖更新
```

## Supabase 配置

### Tables

`notes`（笔记表）

```SQL
create table public.notes (
  id bigint generated by default as identity not null,
  content text null,
  user_id uuid not null default auth.uid (),
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null default now(),
  embedding extensions.vector null,
  constraint notes_pkey primary key (id),
  constraint notes_user_id_fkey foreign KEY (user_id) references auth.users (id)
) TABLESPACE pg_default;

create index IF not exists notes_created_at_idx on public.notes using btree (created_at) TABLESPACE pg_default;

create index IF not exists notes_embedding_idx on public.notes using hnsw (embedding extensions.vector_cosine_ops) TABLESPACE pg_default;

create index IF not exists notes_content_pgroonga_index on public.notes using pgroonga (content) TABLESPACE pg_default;

create trigger notes_updated_at BEFORE
update on notes for EACH row
execute FUNCTION update_updated_at ();
```

### Functions

`hybrid_search_notes`（全文与语义混合搜索函数）

```SQL
CREATE OR REPLACE FUNCTION public.hybrid_search_notes(query_text text, query_embedding vector, match_count integer, full_text_weight double precision DEFAULT 1.0, semantic_weight double precision DEFAULT 1.0, rrf_k integer DEFAULT 50)
 RETURNS SETOF notes
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'pg_catalog', 'public', 'extensions'
AS $function$
BEGIN
  RETURN QUERY
  WITH full_text AS (
    SELECT
      notes.id,
      row_number() OVER (ORDER BY pgroonga_score(tableoid, ctid) DESC) AS rank_ix
    FROM notes
    WHERE notes.content &@~ query_text
    ORDER BY rank_ix
    LIMIT least(match_count, 30) * 2
  ),
  semantic AS (
    SELECT
      notes.id,
      row_number() OVER (ORDER BY notes.embedding <=> query_embedding) AS rank_ix
    FROM notes
    WHERE notes.embedding IS NOT NULL
    ORDER BY rank_ix
    LIMIT least(match_count, 30) * 2
  )
  SELECT notes.*
  FROM full_text
  FULL OUTER JOIN semantic ON full_text.id = semantic.id
  JOIN notes ON coalesce(full_text.id, semantic.id) = notes.id
  ORDER BY
    coalesce(1.0 / (rrf_k + full_text.rank_ix), 0.0) * full_text_weight +
    coalesce(1.0 / (rrf_k + semantic.rank_ix), 0.0) * semantic_weight
    DESC
  LIMIT least(match_count, 30);
END;
$function$
```

## 部署

- 在 Vercel 创建项目并导入 GitHub 仓库
- 根据 `.env.example` 配置环境变量
- 推送 GitHub 自动触发部署
